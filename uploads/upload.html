<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Upload Excel ke GitHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body{font-family:Arial,sans-serif;background:#f4f6f8;padding:40px}
    .box{max-width:560px;margin:auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.1)}
    h3{margin:0 0 14px}
    button{width:100%;padding:12px;margin-top:12px;background:#2563eb;color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{margin-top:10px}
    .muted{color:#6b7280;font-size:12px;margin-top:6px}
    .barwrap{margin-top:12px;background:#e5e7eb;border-radius:999px;overflow:hidden;height:12px}
    .bar{height:12px;width:0%;background:#22c55e;transition:width .15s}
    .status{margin-top:12px;background:#111;color:#0f0;padding:12px;border-radius:10px;font-size:12px;max-height:240px;overflow:auto;white-space:pre-wrap}
    .kpi{display:flex;gap:10px;margin-top:10px}
    .chip{flex:1;background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
    .chip b{display:block;font-size:12px;color:#6b7280}
    .chip span{font-size:14px}
    .warn{color:#f59e0b}
    .err{color:#ef4444}
  </style>
</head>
<body>

<div class="box">
  <h3>Upload Excel ke GitHub</h3>

  <div class="row">
    <input type="file" id="file" accept=".xlsx,.xls" />
    <div class="muted" id="fileInfo">Belum ada file dipilih</div>
  </div>

  <div class="kpi">
    <div class="chip"><b>Tahap</b><span id="phase">Idle</span></div>
    <div class="chip"><b>Progress</b><span id="pct">0%</span></div>
  </div>

  <div class="barwrap"><div class="bar" id="bar"></div></div>

  <button id="btn" onclick="upload()">Upload</button>

  <div class="status" id="log">Status: menunggu upload...</div>
</div>

<script>
/** GANTI jika URL worker kamu berubah */
const WORKER_URL = "https://upload-excel-github-api.crissrnanto6.workers.dev";

const el = (id) => document.getElementById(id);

function setProgress(phase, pct) {
  el("phase").textContent = phase;
  el("pct").textContent = `${pct}%`;
  el("bar").style.width = `${pct}%`;
}

function logLine(msg) {
  el("log").textContent = `${msg}\n` + el("log").textContent;
}

el("file").addEventListener("change", () => {
  const f = el("file").files[0];
  if (!f) {
    el("fileInfo").textContent = "Belum ada file dipilih";
    return;
  }
  const mb = (f.size / (1024 * 1024)).toFixed(2);
  el("fileInfo").textContent = `File: ${f.name} (${mb} MB)`;
});

/**
 * Convert ArrayBuffer -> base64 dengan progress (tahap encoding)
 */
function arrayBufferToBase64WithProgress(buffer, onProgress) {
  const bytes = new Uint8Array(buffer);
  const total = bytes.length;
  const chunkSize = 0x8000; // 32KB
  let binary = "";

  for (let i = 0; i < total; i += chunkSize) {
    const chunk = bytes.subarray(i, i + chunkSize);
    binary += String.fromCharCode.apply(null, chunk);

    const p = Math.min(100, Math.floor((i / total) * 100));
    onProgress(p);
  }

  onProgress(100);
  return btoa(binary);
}

/**
 * POST JSON via XHR agar upload progress bisa terlihat.
 * (fetch belum reliable untuk upload progress)
 */
function xhrPostJson(url, bodyObj, onUploadProgress) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.setRequestHeader("Content-Type", "application/json");

    // Pastikan tidak mengirim credentials
    // (XMLHttpRequest default sudah tanpa credentials untuk cross-origin,
    //  kecuali withCredentials = true)
    xhr.withCredentials = false;

    xhr.upload.onprogress = (evt) => {
      if (evt.lengthComputable) {
        const pct = Math.round((evt.loaded / evt.total) * 100);
        onUploadProgress(pct);
      }
    };

    xhr.onload = () => {
      const status = xhr.status;
      const text = xhr.responseText || "";
      let json;
      try { json = JSON.parse(text); } catch { json = { raw: text }; }
      resolve({ status, json, raw: text });
    };

    xhr.onerror = () => reject(new Error("Network error / CORS blocked"));
    xhr.send(JSON.stringify(bodyObj));
  });
}

async function upload() {
  const f = el("file").files[0];
  if (!f) return alert("Pilih file Excel dulu");

  el("btn").disabled = true;
  el("log").textContent = "Status: mulai...\n";
  setProgress("Reading file", 0);

  try {
    // 1) Read file
    const buffer = await f.arrayBuffer();
    logLine("OK: File dibaca ke memory.");

    // 2) Encode base64 (0-60%)
    setProgress("Encoding base64", 0);
    const base64 = arrayBufferToBase64WithProgress(buffer, (p) => {
      const mapped = Math.round(p * 0.6);
      setProgress("Encoding base64", mapped);
    });
    logLine("OK: Base64 selesai.");

    // 3) Upload (60-100%)
    setProgress("Uploading", 60);
    const { status, json, raw } = await xhrPostJson(
      WORKER_URL,
      {
        filename: f.name,
        contentBase64: base64
      },
      (p) => {
        const mapped = 60 + Math.round(p * 0.4);
        setProgress("Uploading", mapped);
      }
    );

    logLine(`HTTP status: ${status}`);

    // 4) Interpret result
    if (status >= 200 && status < 300) {
      setProgress("Done", 100);
      logLine("SUKSES: Upload selesai.");
      logLine(JSON.stringify(json, null, 2));
    } else {
      setProgress("Finished (error)", 100);
      logLine("GAGAL: Worker/GitHub mengembalikan error.");
      logLine("Response JSON / raw:");
      logLine(JSON.stringify(json, null, 2));
      if (raw && raw !== JSON.stringify(json)) logLine(raw);
    }
  } catch (err) {
    setProgress("Error", 100);
    logLine("ERROR: " + err.message);
    logLine("Catatan: Jika ini 'Network error / CORS', berarti preflight/headers di Worker belum benar.");
  } finally {
    el("btn").disabled = false;
  }
}
</script>

</body>
</html>
