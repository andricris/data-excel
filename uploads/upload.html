<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload Excel ke GitHub</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --chip:#f1f5f9;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1100px;
      margin:28px auto;
      padding:0 16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    h1{
      font-size:22px;
      margin:0 0 4px;
      letter-spacing:.2px;
    }
    .sub{
      color:var(--muted);
      font-size:13px;
      margin:0 0 14px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 880px){
      .grid{grid-template-columns:1fr}
    }
    .panel{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      font-weight:600;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    input[type="password"], input[type="text"]{
      width:320px;
      max-width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:10px;
      outline:none;
      font-size:13px;
    }
    input[type="file"]{
      font-size:13px;
      max-width:100%;
    }
    .btn{
      border:0;
      border-radius:10px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      color:#fff;
      background:var(--primary);
    }
    .btn:hover{background:var(--primary2)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .btn.secondary{
      background:#0f172a;
    }
    .btn.secondary:hover{background:#111827}
    .btn.gray{
      background:#334155;
    }
    .btn.gray:hover{background:#1f2937}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--chip);
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .pill b{color:var(--text)}
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 520px){
      .kpis{grid-template-columns:1fr}
    }
    .kpi{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .kpi .t{color:var(--muted); font-size:12px; font-weight:600}
    .kpi .v{margin-top:6px; font-weight:800}
    .barwrap{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      height:12px;
      background:#eef2ff;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transition: width .12s ease;
    }
    .actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .muted{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .log{
      margin-top:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0b1220;
      color:#c7f9cc;
      padding:12px;
      font-family:var(--mono);
      font-size:12px;
      white-space:pre-wrap;
      min-height:110px;
      max-height:220px;
      overflow:auto;
    }
    .listcard{
      margin-top:14px;
      border-top:1px dashed var(--line);
      padding-top:14px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      text-align:left;
      vertical-align:middle;
    }
    th{
      color:var(--muted);
      font-size:12px;
      letter-spacing:.2px;
      font-weight:800;
    }
    a{color:var(--primary); text-decoration:none}
    a:hover{text-decoration:underline}
    .right{ text-align:right }
    .small{ font-size:12px; color:var(--muted) }
    .badge{
      display:inline-block;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      font-weight:700;
    }
    .ok{ color: var(--ok) }
    .bad{ color: var(--bad) }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Upload Excel ke GitHub</h1>
      <p class="sub">UI (GitHub Pages) → Cloudflare Worker → GitHub Repo (<code>/uploads</code>)</p>

      <div class="grid">
        <div class="panel">
          <div class="label">Auth (PIN/Key)</div>
          <div class="row">
            <input id="key" type="password" placeholder="Masukkan PIN/KEY" autocomplete="off" />
            <button class="btn secondary" id="saveKeyBtn">Simpan</button>
            <button class="btn gray" id="clearKeyBtn">Hapus</button>
          </div>
          <div style="margin-top:8px" class="pill">
            <span id="keyState" class="badge">Belum ada key</span>
            <span class="small">Key disimpan di <b>sessionStorage</b> (hilang saat browser ditutup)</span>
          </div>
          <p class="muted" style="margin:10px 0 0">
            PIN divalidasi di Worker (secret <b>UPLOAD_KEY</b>), bukan di browser.
          </p>
        </div>

        <div class="panel">
          <div class="label">File</div>
          <div class="row">
            <input id="file" type="file" accept=".xlsx,.xls" />
          </div>
          <div class="muted" style="margin-top:8px" id="fileInfo">Belum ada file dipilih</div>

          <div class="kpis">
            <div class="kpi">
              <div class="t">Tahap</div>
              <div class="v" id="phase">Idle</div>
            </div>
            <div class="kpi">
              <div class="t">Progress (real upload)</div>
              <div class="v" id="pct">0%</div>
            </div>
          </div>

          <div class="barwrap"><div class="bar" id="bar"></div></div>

          <div class="actions">
            <div class="row">
              <button class="btn" id="uploadBtn">Upload</button>
              <button class="btn secondary" id="refreshBtn">Refresh List</button>
            </div>
            <div class="muted">
              Worker: <span id="workerUrlText"></span>
            </div>
          </div>

          <div class="log" id="log">Status: menunggu...</div>
        </div>
      </div>

      <div class="listcard">
        <div class="row" style="justify-content:space-between">
          <div>
            <b>List file Excel di repo</b> <span class="badge">hanya .xlsx/.xls</span>
            <div class="small">Folder: <code>/uploads</code> (di repo)</div>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Nama</th>
              <th class="right">Ukuran</th>
              <th>Link Repo</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="4" class="small">Klik “Refresh List” untuk memuat.</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

<script>
/** ====== KONFIG ====== */
// GANTI sesuai URL worker kamu
const WORKER_BASE = "https://upload-excel-github-api.crissrinanto6.workers.dev";
const ENDPOINT_UPLOAD = WORKER_BASE + "/upload";
const ENDPOINT_LIST   = WORKER_BASE + "/list";
const ENDPOINT_DL     = WORKER_BASE + "/download";
const ENDPOINT_DELETE = WORKER_BASE + "/delete";

/** ====== UTIL ====== */
const el = (id) => document.getElementById(id);
el("workerUrlText").textContent = WORKER_BASE;

function logLine(msg){
  el("log").textContent = msg + "\n" + el("log").textContent;
}
function setProgress(phase, pct){
  el("phase").textContent = phase;
  el("pct").textContent = `${pct}%`;
  el("bar").style.width = `${pct}%`;
}
function bytesToMB(n){
  return (n / (1024 * 1024)).toFixed(2);
}
function getKey(){
  return sessionStorage.getItem("UPLOAD_KEY") || "";
}
function setKeyUI(){
  const k = getKey();
  if (k){
    el("keyState").textContent = "Key tersimpan";
    el("keyState").classList.remove("bad");
    el("keyState").classList.add("ok");
  } else {
    el("keyState").textContent = "Belum ada key";
    el("keyState").classList.remove("ok");
    el("keyState").classList.add("bad");
  }
}
setKeyUI();

/** ====== EVENTS ====== */
el("saveKeyBtn").addEventListener("click", () => {
  const k = (el("key").value || "").trim();
  if (!k) return alert("Masukkan PIN/KEY dulu.");
  sessionStorage.setItem("UPLOAD_KEY", k);
  el("key").value = "";
  setKeyUI();
  logLine("OK: Key tersimpan di sessionStorage.");
});

el("clearKeyBtn").addEventListener("click", () => {
  sessionStorage.removeItem("UPLOAD_KEY");
  setKeyUI();
  logLine("OK: Key dihapus dari sessionStorage.");
});

el("file").addEventListener("change", () => {
  const f = el("file").files && el("file").files[0];
  if (!f){
    el("fileInfo").textContent = "Belum ada file dipilih";
    return;
  }
  el("fileInfo").textContent = `File: ${f.name} (${bytesToMB(f.size)} MB)`;
  setProgress("Siap", 0);
});

/** ====== READ BASE64 ====== */
function readFileAsBase64(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error("Gagal membaca file"));
    reader.onload = () => {
      const result = reader.result || "";
      // result = data:...;base64,xxxx
      const base64 = String(result).split(",")[1] || "";
      resolve(base64);
    };
    reader.readAsDataURL(file);
  });
}

/** ====== REAL UPLOAD PROGRESS via XHR ====== */
function xhrJson(url, { method="POST", headers={}, bodyObj=null, onProgress=null } = {}){
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open(method, url, true);
    for (const [k,v] of Object.entries(headers)) xhr.setRequestHeader(k, v);

    xhr.responseType = "text";

    xhr.upload.onprogress = (evt) => {
      if (evt.lengthComputable && typeof onProgress === "function"){
        const pct = Math.round((evt.loaded / evt.total) * 100);
        onProgress(pct);
      }
    };

    xhr.onload = () => {
      resolve({
        status: xhr.status,
        text: xhr.responseText
      });
    };
    xhr.onerror = () => reject(new Error("Network error / CORS blocked"));
    xhr.ontimeout = () => reject(new Error("Request timeout"));

    const payload = bodyObj ? JSON.stringify(bodyObj) : null;
    xhr.send(payload);
  });
}

/** ====== UPLOAD ====== */
async function doUpload(){
  const key = getKey();
  if (!key) return alert("Key belum disimpan. Isi PIN/KEY lalu klik Simpan.");

  const f = el("file").files && el("file").files[0];
  if (!f) return alert("Pilih file Excel dulu.");

  const nameLower = (f.name || "").toLowerCase();
  if (!(nameLower.endsWith(".xlsx") || nameLower.endsWith(".xls"))){
    return alert("Hanya boleh .xlsx atau .xls");
  }

  el("uploadBtn").disabled = true;
  try{
    setProgress("Baca file", 0);
    logLine("Status: mulai baca file...");
    const base64 = await readFileAsBase64(f);
    logLine("OK: File berhasil dibaca (base64).");

    setProgress("Upload", 0);
    logLine("Status: upload ke Worker...");

    const res = await xhrJson(ENDPOINT_UPLOAD, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Upload-Key": key
      },
      bodyObj: {
        filename: f.name,
        contentBase64: base64
      },
      onProgress: (pct) => {
        // progress real untuk request body (base64 json)
        setProgress("Upload", pct);
      }
    });

    if (res.status >= 200 && res.status < 300){
      setProgress("Selesai", 100);
      logLine(`OK: Upload selesai. Status HTTP: ${res.status}`);
      await refreshList();
    } else {
      setProgress("Error", 100);
      logLine(`ERROR: Upload gagal (${res.status}): ${res.text.slice(0, 350)}`);
      alert("Upload gagal. Buka DevTools > Network untuk detail.");
    }
  } catch(e){
    setProgress("Error", 100);
    logLine("ERROR: " + (e?.message || e));
    alert("Upload error: " + (e?.message || e));
  } finally {
    el("uploadBtn").disabled = false;
  }
}
el("uploadBtn").addEventListener("click", doUpload);

/** ====== LIST (ONLY EXCEL) ====== */
async function refreshList(){
  const key = getKey();
  if (!key) return alert("Key belum disimpan. Isi PIN/KEY lalu klik Simpan.");

  el("refreshBtn").disabled = true;
  try{
    logLine("Status: ambil list file...");
    const r = await fetch(ENDPOINT_LIST, {
      method: "GET",
      headers: { "X-Upload-Key": key }
    });

    const txt = await r.text();
    if (!r.ok){
      logLine(`ERROR: list gagal (${r.status}): ${txt.slice(0, 250)}`);
      return;
    }

    let data = {};
    try { data = JSON.parse(txt); } catch {}
    let files = (data && data.files) ? data.files : [];

    // FILTER: tampilkan hanya Excel
    files = files.filter(f => {
      const n = (f.name || "").toLowerCase();
      return n.endsWith(".xlsx") || n.endsWith(".xls");
    });

    renderTable(files);
    logLine(`OK: List sukses (${files.length} file Excel).`);
  } catch(e){
    logLine("ERROR: " + (e?.message || e));
  } finally {
    el("refreshBtn").disabled = false;
  }
}
el("refreshBtn").addEventListener("click", refreshList);

/** ====== TABLE RENDER ====== */
function renderTable(files){
  const tb = el("tbody");
  if (!files.length){
    tb.innerHTML = `<tr><td colspan="4" class="small">Tidak ada file Excel di <code>/uploads</code>.</td></tr>`;
    return;
  }

  tb.innerHTML = files.map(f => {
    const size = f.size ? bytesToMB(f.size) + " MB" : "-";
    const viewUrl = f.html_url || "#";
    const encName = encodeURIComponent(f.name || "");
    return `
      <tr>
        <td><b>${escapeHtml(f.name || "")}</b><div class="small">${escapeHtml(f.path || "")}</div></td>
        <td class="right">${size}</td>
        <td><a href="${viewUrl}" target="_blank" rel="noopener">View</a></td>
        <td>
          <button class="btn secondary" data-dl="${encName}">Download</button>
          <button class="btn gray" data-del="${encName}">Hapus</button>
        </td>
      </tr>
    `;
  }).join("");

  // bind download
  tb.querySelectorAll("button[data-dl]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const name = decodeURIComponent(btn.getAttribute("data-dl") || "");
      await downloadFile(name);
    });
  });

  // bind delete
  tb.querySelectorAll("button[data-del]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const name = decodeURIComponent(btn.getAttribute("data-del") || "");
      await deleteFile(name);
    });
  });
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** ====== DOWNLOAD (via Worker) ====== */
async function downloadFile(name){
  const key = getKey();
  if (!key) return alert("Key belum disimpan.");

  logLine(`Status: download ${name}...`);
  try{
    const url = ENDPOINT_DL + "?filename=" + encodeURIComponent(name);
    const r = await fetch(url, { headers: { "X-Upload-Key": key } });
    if (!r.ok){
      const t = await r.text();
      logLine(`ERROR: download gagal (${r.status}): ${t.slice(0, 250)}`);
      return;
    }
    const blob = await r.blob();
    const a = document.createElement("a");
    const objUrl = URL.createObjectURL(blob);
    a.href = objUrl;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(objUrl);
    logLine("OK: download siap.");
  } catch(e){
    logLine("ERROR: " + (e?.message || e));
  }
}

/** ====== DELETE (via Worker) ====== */
async function deleteFile(name){
  const key = getKey();
  if (!key) return alert("Key belum disimpan.");

  const ok = confirm(`Yakin hapus file ini?\n\n${name}`);
  if (!ok) return;

  logLine(`Status: hapus ${name}...`);
  try{
    const r = await fetch(ENDPOINT_DELETE, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "X-Upload-Key": key
      },
      body: JSON.stringify({ filename: name })
    });

    const t = await r.text();
    if (!r.ok){
      logLine(`ERROR: hapus gagal (${r.status}): ${t.slice(0, 250)}`);
      alert("Hapus gagal. Cek log.");
      return;
    }

    logLine("OK: file berhasil dihapus.");
    await refreshList();
  } catch(e){
    logLine("ERROR: " + (e?.message || e));
  }
}

// auto list setelah load (kalau key ada)
window.addEventListener("load", () => {
  if (getKey()) refreshList();
});
</script>
</body>
</html>
